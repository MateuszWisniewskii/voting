import * as anchor from "@coral-xyz/anchor";
import { Program, BN } from "@coral-xyz/anchor";
import { Voting } from "../target/types/voting";
import { BankrunProvider, startAnchor } from "anchor-bankrun";
import { AccountInfo, Keypair, PublicKey, SystemProgram } from "@solana/web3.js";
import { Clock } from "solana-bankrun";

const IDL = require("../target/idl/voting.json");

// funkcje ułatwiające manipulacje czasem
async function setClock(context: any, newTimestamp: number | bigint) {
  const client = context.banksClient;
  const oldClock = await client.getClock();

  const newClock = new Clock(
    oldClock.slot,
    oldClock.epochStartTimestamp,
    oldClock.epoch,
    oldClock.leaderScheduleEpoch,
    BigInt(newTimestamp), //tuż przed zakończeniem głosowania: 1700009999 , równo zakończenie możliwości głosowania: 1700010000
  );

  context.setClock(newClock);
  return newClock;
}

// funkcja do wyświetlania aktualnego czasu
function logClock(clock: Clock) {
  console.log("---------------------------");
  console.log("Aktualny czas w symulacji (Unix Timestamp):", clock.unixTimestamp);
  console.log("Aktualny czas w symulacji:", new Date(Number(clock.unixTimestamp) * 1000).toLocaleString());
  console.log("---------------------------");
}

// funkcja do wyświetlania danego PDA oraz seedów
function logPda(name: string, pda: PublicKey, seeds: (Buffer | Uint8Array | string)[]) {
  console.log("---------------------------");
  console.log(`${name} PDA: ${pda.toBase58()}`);
  console.log("Seeds:");
  seeds.forEach((s, i) => {
    if (typeof s === "string") {
      console.log(`  [${i}]: "${s}"`);
    } else if (s instanceof Buffer || s instanceof Uint8Array) {
      console.log(`  [${i}]:`, Buffer.from(s).toString("hex"));
    } else {
      console.log(`  [${i}]:`, s);
    }
  });
  console.log("---------------------------");
}

// funkcja do wyświetlania balancu danego konta
async function printBalance(context: any, name: string, publicKey: PublicKey) {
  const balance = await context.banksClient.getBalance(publicKey);

  console.log("---------------------------");
  console.log(`${name} publicKey: ${publicKey.toBase58()}`);
  console.log(`${name} lamports: ${balance}`);
  console.log(`${name} SOL: ${Number(balance) / 1_000_000_000}`);
  console.log("---------------------------");
}

// funkcja do konwersji kwoty w SOL na lamporty
function solToLamports(solAmount: number) {
  return solAmount * anchor.web3.LAMPORTS_PER_SOL;
}

describe("Ogólny test działania kontraktu", () => {
  // zmienne globalne dla testu

  // niezbędne zmienne do działania bankrun
  let context;
  let provider;
  let puppetProgram;

  // zmienne wymagane do manipulacji czasem
  let client;
  let currentClock;

  // zmienne do utwworzenia kontraktu
  let pollId = 1;
  let votingStart = 1700000000; // Unix Timestamp. Tue Nov 14 2023 23:13:20 GMT+0100 (czas środkowoeuropejski standardowy)
  let votingEnd = 1700010000; // Wed Nov 15 2023 02:00:00 GMT+0100 (czas środkowoeuropejski standardowy)
  let pollName = "Nazwa testowego wydarzenia";
  let pollDescription = "Opis testowego wydarzenia";
  let nameCandidateA = "Candidate A";
  let nameCandidateB = "Candidate B";
  let nameCandidateC = "Candidate C";

  // konta użytkowników
  let authority; // admin bądź jednostka odpowiedzialna za tworzenie i zarządzanie wydarzeniem 
  let userA; // zwykły użytkownik kontraktu, który bierze udział w głosowaniu
  let userB;
  let userC;

  // seedy dla adresów pochodnych programu
  let pollSeeds;
  let candidateASeeds;
  let candidateBSeeds;
  let userAVoteSeeds;
  let userBVoteSeeds;
  let userCVoteSeeds;

  // adresy pochodne programu
  let pollPda;
  let candidateAPda;
  let candidateBPda;
  let userAVotePda;
  let userBVotePda;
  let userCVotePda;

  before("initialization", async () => {

    // Generowanie kluczy
    authority = Keypair.generate();
    userA = Keypair.generate();
    userB = Keypair.generate();
    userC = Keypair.generate();

    // zasilanie kont użytkowinków
    const accounts = [authority, userA, userB, userC].map(user => ({
      address: user.publicKey,
      info: {
        lamports: solToLamports(9), // każdy użytkownik dostaje 9 SOL
        data: Buffer.alloc(0), // puste konto
        owner: SystemProgram.programId,
        executable: false, // zaznaczenie że to konto nie jest programem
        rentEpoch: 0,
      } as AccountInfo<Buffer>
    }));
    accounts.forEach(acc => {
      console.log("Address:", acc.address.toBase58());
      console.log("Lamports:", acc.info.lamports);
      console.log("Owner:", acc.info.owner.toBase58());
      console.log("Executable:", acc.info.executable);
      console.log("Rent epoch:", acc.info.rentEpoch);
      console.log("---------------------------");
    });

    // inicjalizacja środowiska testowego
    context = await startAnchor("../voting", [], accounts);
    provider = new BankrunProvider(context);
    puppetProgram = new Program<Voting>(IDL, provider);

    // inicjalizacja seedów dla adresów pochodnych programu
    pollSeeds = [
      Buffer.from("poll_seed"),
      new BN(pollId).toArrayLike(Buffer, "le", 8),
    ];

    candidateASeeds = [
      Buffer.from("candidate_seed"),
      new BN(pollId).toArrayLike(Buffer, "le", 8),
      Buffer.from(nameCandidateA),
    ];

    candidateBSeeds = [
      Buffer.from("candidate_seed"),
      new BN(pollId).toArrayLike(Buffer, "le", 8),
      Buffer.from(nameCandidateB),
    ];

    userAVoteSeeds = [
      Buffer.from("vote_seed"),
      userA.publicKey.toBytes(),
      new BN(pollId).toArrayLike(Buffer, "le", 8),
    ];

    userBVoteSeeds = [
      Buffer.from("vote_seed"),
      userB.publicKey.toBytes(),
      new BN(pollId).toArrayLike(Buffer, "le", 8),
    ];

    userCVoteSeeds = [
      Buffer.from("vote_seed"),
      userC.publicKey.toBytes(),
      new BN(pollId).toArrayLike(Buffer, "le", 8),
    ];

    // inicjalizacja adresów pochodnych programu (PDA)
    [pollPda] = PublicKey.findProgramAddressSync(
      pollSeeds,
      puppetProgram.programId
    );

    [candidateAPda] = PublicKey.findProgramAddressSync(
      candidateASeeds,
      puppetProgram.programId
    );

    [candidateBPda] = PublicKey.findProgramAddressSync(
      candidateBSeeds,
      puppetProgram.programId
    );

    [userAVotePda] = PublicKey.findProgramAddressSync(
      userAVoteSeeds,
      puppetProgram.programId
    );

    [userBVotePda] = PublicKey.findProgramAddressSync(
      userBVoteSeeds,
      puppetProgram.programId
    );

    [userCVotePda] = PublicKey.findProgramAddressSync(
      userCVoteSeeds,
      puppetProgram.programId
    );

    // inicjalizacja zegara
    client = context.banksClient;
    currentClock = await client.getClock();

    // Kontrolne wypisanie po inicjalizacji 
    logClock(currentClock);

    await printBalance(context, "authority", authority.publicKey);
    await printBalance(context, "userA", userA.publicKey);
    await printBalance(context, "userB", userB.publicKey);
    await printBalance(context, "userC", userC.publicKey);

    logPda("Poll", pollPda, pollSeeds);
    logPda("Candidate A", candidateAPda, candidateASeeds);
    logPda("Candidate B", candidateBPda, candidateBSeeds);
    logPda("UserA Vote", userAVotePda, userAVoteSeeds);
    logPda("UserB Vote", userBVotePda, userBVoteSeeds);
    logPda("UserC Vote", userCVotePda, userCVoteSeeds);

  });
});